<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TaskVibe</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.development.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios@1.4.0/dist/axios.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/babel-standalone@7.22.9/Babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        function App() {
            const [isAuthenticated, setIsAuthenticated] = React.useState(false);
            const [username, setUsername] = React.useState('');
            const [password, setPassword] = React.useState('');
            const [email, setEmail] = React.useState('');
            const [tasks, setTasks] = React.useState([]);
            const [title, setTitle] = React.useState('');
            const [description, setDescription] = React.useState('');
            const [energyLevel, setEnergyLevel] = React.useState('LOW');
            const [dueDate, setDueDate] = React.useState('');
            const [photo, setPhoto] = React.useState(null);
            const [mood, setMood] = React.useState('');
            const [dailyPhoto, setDailyPhoto] = React.useState(null);
            const [moods, setMoods] = React.useState([]);
            const [groups, setGroups] = React.useState([]);
            const [challenges, setChallenges] = React.useState([]);
            const [analytics, setAnalytics] = React.useState(null);
            const [challengeUpdates, setChallengeUpdates] = React.useState([]);

            React.useEffect(() => {
                const token = localStorage.getItem('access_token');
                if (token) {
                    axios.defaults.headers.common['Authorization'] = `Bearer ${token}`;
                    setIsAuthenticated(true);
                    fetchData();
                }
            }, []);

            const fetchData = () => {
                axios.get('/api/tasks/').then(response => setTasks(response.data));
                axios.get('/api/photos/').then(response => {
                    if (response.data.length > 0) setDailyPhoto(response.data[0]);
                });
                axios.get('/api/moods/').then(response => setMoods(response.data));
                axios.get('/api/groups/').then(response => setGroups(response.data));
                axios.get('/api/challenges/').then(response => setChallenges(response.data));
                axios.get('/api/analytics/').then(response => setAnalytics(response.data));
            };

            // WebSocket for challenge updates
            React.useEffect(() => {
                if (groups.length > 0) {
                    const ws = new WebSocket(`ws://localhost:8000/ws/challenge/${groups[0]?.id}/`);
                    ws.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        setChallengeUpdates(prev => [...prev, data.message]);
                    };
                    return () => ws.close();
                }
            }, [groups]);

            const handleRegister = () => {
                axios.post('/api/register/', { username, password, email })
                    .then(response => {
                        localStorage.setItem('access_token', response.data.access);
                        localStorage.setItem('user_id', response.data.user_id);
                        axios.defaults.headers.common['Authorization'] = `Bearer ${response.data.access}`;
                        setIsAuthenticated(true);
                        fetchData();
                    })
                    .catch(error => alert(error.response.data.error));
            };

            const handleLogin = () => {
                axios.post('/api/login/', { username, password })
                    .then(response => {
                        localStorage.setItem('access_token', response.data.access);
                        localStorage.setItem('user_id', response.data.user_id);
                        axios.defaults.headers.common['Authorization'] = `Bearer ${response.data.access}`;
                        setIsAuthenticated(true);
                        fetchData();
                    })
                    .catch(error => alert(error.response.data.error));
            };

            const handleAddTask = () => {
                axios.post('/api/tasks/', { title, description, energy_level: energyLevel, due_date: dueDate })
                    .then(response => {
                        setTasks([...tasks, response.data]);
                        setTitle('');
                        setDescription('');
                        setDueDate('');
                    });
            };

            const handleCompleteTask = (taskId) => {
                axios.post(`/api/tasks/${taskId}/complete/`)
                    .then(() => {
                        setTasks(tasks.map(task => 
                            task.id === taskId ? { ...task, completed: true } : task
                        ));
                        if (groups.length > 0 && challenges.length > 0) {
                            const ws = new WebSocket(`ws://localhost:8000/ws/challenge/${groups[0].id}/`);
                            ws.onopen = () => {
                                ws.send(JSON.stringify({
                                    challenge_id: challenges[0].id,
                                    user_id: localStorage.getItem('user_id')
                                }));
                            };
                        }
                    });
            };

            const handleUploadPhoto = () => {
                const formData = new FormData();
                formData.append('photo', photo);
                formData.append('mood', mood);
                axios.post('/api/photos/', formData, {
                    headers: { 'Content-Type': 'multipart/form-data' }
                }).then(response => {
                    setDailyPhoto(response.data);
                    setPhoto(null);
                    setMood('');
                });
            };

            const handleAddMood = () => {
                axios.post('/api/moods/', { mood })
                    .then(response => {
                        setMoods([...moods, response.data]);
                        setMood('');
                    });
            };

            const handleCreateGroup = () => {
                axios.post('/api/groups/', { name: `Group ${new Date().toLocaleString()}` })
                    .then(response => setGroups([...groups, response.data]));
            };

            const handleCreateChallenge = () => {
                axios.post('/api/challenges/', {
                    group: groups[0]?.id,
                    title: `Challenge ${new Date().toLocaleString()}`,
                    description: 'Complete tasks!',
                    target_tasks: 5,
                    deadline: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString()
                }).then(response => setChallenges([...challenges, response.data]));
            };

            React.useEffect(() => {
                if (analytics && document.getElementById('analyticsChart')) {
                    new Chart(document.getElementById('analyticsChart'), {
                        type: 'bar',
                        data: {
                            labels: ['Completed', 'Remaining'],
                            datasets: [{
                                label: 'Tasks',
                                data: [
                                    analytics.daily_report.completed_tasks,
                                    analytics.daily_report.total_tasks - analytics.daily_report.completed_tasks
                                ],
                                backgroundColor: ['#10B981', '#EF4444']
                            }]
                        },
                        options: {
                            scales: {
                                y: { beginAtZero: true }
                            }
                        }
                    });
                }
            }, [analytics]);

            if (!isAuthenticated) {
                return (
                    <div className="container mx-auto p-4">
                        <h1 className="text-3xl font-bold mb-4">TaskVibe</h1>
                        <div className="mb-8">
                            <h2 className="text-xl font-semibold mb-2">Register</h2>
                            <input type="text" placeholder="Username" value={username} onChange={e => setUsername(e.target.value)} className="border p-2 mb-2 w-full" />
                            <input type="email" placeholder="Email" value={email} onChange={e => setEmail(e.target.value)} className="border p-2 mb-2 w-full" />
                            <input type="password" placeholder="Password" value={password} onChange={e => setPassword(e.target.value)} className="border p-2 mb-2 w-full" />
                            <button onClick={handleRegister} className="bg-blue-500 text-white p-2 rounded">Register</button>
                        </div>
                        <div>
                            <h2 className="text-xl font-semibold mb-2">Login</h2>
                            <input type="text" placeholder="Username" value={username} onChange={e => setUsername(e.target.value)} className="border p-2 mb-2 w-full" />
                            <input type="password" placeholder="Password" value={password} onChange={e => setPassword(e.target.value)} className="border p-2 mb-2 w-full" />
                            <button onClick={handleLogin} className="bg-green-500 text-white p-2 rounded">Login</button>
                        </div>
                    </div>
                );
            }

            return (
                <div className="container mx-auto p-4">
                    <h1 className="text-3xl font-bold mb-4">TaskVibe</h1>
                    
                    {/* Task Form */}
                    <div className="mb-8">
                        <h2 className="text-xl font-semibold mb-2">Add New Task</h2>
                        <input type="text" value={title} onChange={e => setTitle(e.target.value)} placeholder="Task Title" className="border p-2 mb-2 w-full" />
                        <textarea value={description} onChange={e => setDescription(e.target.value)} placeholder="Task Description" className="border p-2 mb-2 w-full" />
                        <select value={energyLevel} onChange={e => setEnergyLevel(e.target.value)} className="border p-2 mb-2 w-full">
                            <option value="LOW">Low Energy</option>
                            <option value="MEDIUM">Medium Energy</option>
                            <option value="HIGH">High Energy</option>
                        </select>
                        <input type="datetime-local" value={dueDate} onChange={e => setDueDate(e.target.value)} className="border p-2 mb-2 w-full" />
                        <button onClick={handleAddTask} className="bg-blue-500 text-white p-2 rounded">Add Task</button>
                    </div>

                    {/* Tasks List */}
                    <div className="mb-8">
                        <h2 className="text-xl font-semibold mb-2">Your Tasks</h2>
                        <ul>
                            {tasks.map(task => (
                                <li key={task.id} className="border p-2 mb-2 flex justify-between">
                                    <span>{task.title} - {task.description} ({task.energy_level}) {task.completed && <span className="text-green-500">âœ”</span>}</span>
                                    {!task.completed && <button onClick={() => handleCompleteTask(task.id)} className="bg-green-500 text-white p-1 rounded">Complete</button>}
                                </li>
                            ))}
                        </ul>
                    </div>

                    {/* Photo Upload */}
                    <div className="mb-8">
                        <h2 className="text-xl font-semibold mb-2">Upload Daily Photo</h2>
                        <input type="file" onChange={e => setPhoto(e.target.files[0])} className="mb-2" />
                        <input type="text" value={mood} onChange={e => setMood(e.target.value)} placeholder="Your Mood" className="border p-2 mb-2 w-full" />
                        <button onClick={handleUploadPhoto} className="bg-green-500 text-white p-2 rounded">Upload Photo</button>
                    </div>

                    {dailyPhoto && (
                        <div className="mb-8">
                            <h2 className="text-xl font-semibold mb-2">Today's Photo</h2>
                            <img src={dailyPhoto.photo} alt="Daily Photo" className="max-w-xs" />
                            <p>Mood: {dailyPhoto.mood}</p>
                        </div>
                    )}

                    {/* Mood */}
                    <div className="mb-8">
                        <h2 className="text-xl font-semibold mb-2">Record Your Mood</h2>
                        <select value={mood} onChange={e => setMood(e.target.value)} className="border p-2 mb-2 w-full">
                            <option value="">Select Mood</option>
                            <option value="HAPPY">Happy</option>
                            <option value="TIRED">Tired</option>
                            <option value="ANXIOUS">Anxious</option>
                            <option value="EXCITED">Excited</option>
                        </select>
                        <button onClick={handleAddMood} className="bg-purple-500 text-white p-2 rounded">Record Mood</button>
                    </div>

                    {/* Groups and Challenges */}
                    <div className="mb-8">
                        <h2 className="text-xl font-semibold mb-2">Groups & Challenges</h2>
                        <button onClick={handleCreateGroup} className="bg-blue-500 text-white p-2 rounded mb-2">Create Group</button>
                        <button onClick={handleCreateChallenge} className="bg-blue-500 text-white p-2 rounded mb-2">Create Challenge</button>
                        <ul>
                            {challenges.map(challenge => (
                                <li key={challenge.id} className="border p-2 mb-2">
                                    {challenge.title} - Target: {challenge.target_tasks} tasks by {new Date(challenge.deadline).toLocaleDateString()}
                                </li>
                            ))}
                        </ul>
                        <h3 className="text-lg font-semibold mt-4">Challenge Updates</h3>
                        <ul>
                            {challengeUpdates.map((update, index) => (
                                <li key={index}>User {update.user_id} completed {update.completed_tasks} tasks</li>
                            ))}
                        </ul>
                    </div>

                    {/* Analytics */}
                    {analytics && (
                        <div className="mb-8">
                            <h2 className="text-xl font-semibold mb-2">Daily Report</h2>
                            <canvas id="analyticsChart" className="max-w-md"></canvas>
                            <p>Completion Rate: {analytics.daily_report.completion_rate.toFixed(2)}%</p>
                            <h3 className="text-lg font-semibold mt-4">Smart Suggestions</h3>
                            <ul>
                                {analytics.suggestions.map((suggestion, index) => (
                                    <li key={index}>{suggestion.title} ({suggestion.energy_level})</li>
                                ))}
                            </ul>
                            <h3 className="text-lg font-semibold mt-4">Mood Analysis</h3>
                            <ul>
                                {analytics.mood_analysis.map((mood, index) => (
                                    <li key={index}>{mood.mood}: {mood.count} times</li>
                                ))}
                            </ul>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>